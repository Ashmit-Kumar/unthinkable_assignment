<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Wishlist</title>
  <style>
    /* üîπ Simple Loader Spinner */
    #loader {
      display: none;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>üé§ Voice to Wishlist</h2>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn">Stop & Upload</button>

  <!-- üîπ Loader -->
  <div id="loader"></div>

  <p><b>Recognized Text:</b> <span id="recognized"></span></p>
  <pre id="llmResponse"></pre>

  <div id="confirmBox" style="display:none;">
    <p>Are you sure you want to update your wishlist?</p>
    <button id="confirmBtn">Yes</button>
    <button id="cancelBtn">No</button>
  </div>

  <h3>üõí Your Wishlist</h3>
  <ul id="wishlist"></ul>

  <h3>‚ú® Recommended for You</h3>
  <ul id="recommendations"></ul>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream;
    let recordTimeout;
    let lastLLMResponse = null;
    const username = "aseem";  // <- fixed username for now

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const recognized = document.getElementById("recognized");
    const llmResponseBox = document.getElementById("llmResponse");
    const confirmBox = document.getElementById("confirmBox");
    const confirmBtn = document.getElementById("confirmBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const wishlist = document.getElementById("wishlist");
    const recommendations = document.getElementById("recommendations");
    const loader = document.getElementById("loader");

    // üîπ Function to fetch wishlist
    async function loadWishlist() {
      let res = await fetch(`http://127.0.0.1:8000/wishlist/${username}`);
      let data = await res.json();
      wishlist.innerHTML = ""; 
      if (data.wishlist) {
        data.wishlist.forEach(item => {
          let li = document.createElement("li");
          li.textContent = `${item.quantity} √ó ${item.product} (${item.category})`;
          wishlist.appendChild(li);
        });
      }
    }

    // üîπ Function to fetch recommendations
    async function loadRecommendations() {
      let res = await fetch(`http://127.0.0.1:8000/recommendations/${username}`);
      let data = await res.json();
      recommendations.innerHTML = ""; 
      if (data.recommendations) {
        data.recommendations.forEach(item => {
          let li = document.createElement("li");
          li.textContent = `${item.product} (${item.category}) - ‚Çπ${item.price} | Stock: ${item.quantity}`;
          recommendations.appendChild(li);
        });
      } else {
        recommendations.innerHTML = "<li>No recommendations found</li>";
      }
    }

    // Load wishlist + recommendations on page load
    window.onload = async () => {
      await loadWishlist();
      await loadRecommendations();
    };

    // üé§ Start recording
    startBtn.onclick = async () => {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(mediaStream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.start();

      // Optional: Auto-stop after 10s
      recordTimeout = setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          stopBtn.click();
        }
      }, 10000);
    };

    // ‚èπ Stop recording
    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }

      // ‚úÖ Release microphone
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
      }

      clearTimeout(recordTimeout);

      // Show loader before API call
      loader.style.display = "block";
      recognized.textContent = "";

      mediaRecorder.onstop = async () => {
        let blob = new Blob(audioChunks, { type: "audio/webm" });
        let formData = new FormData();
        formData.append("file", blob, "voice.webm");

        let response = await fetch("http://127.0.0.1:8000/recognise_text_to_llm", {
          method: "POST",
          body: formData
        });
        let result = await response.json();

        // Hide loader after response
        loader.style.display = "none";

        if (result.recognized_text) {
          recognized.textContent = result.recognized_text;
          llmResponseBox.textContent = JSON.stringify(result.llm_response, null, 2);
          lastLLMResponse = result.llm_response;
          confirmBox.style.display = "block";
        } else {
          recognized.textContent = "Error: " + result.error;
        }
      };
    };

    // ‚úÖ Confirm update
    confirmBtn.onclick = async () => {
      let response = await fetch(`http://127.0.0.1:8000/update_wishlist/${username}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastLLMResponse)
      });
      let result = await response.json();

      if (result.message) {
        alert("‚úÖ " + result.message);
        confirmBox.style.display = "none";
        await loadWishlist();       
        await loadRecommendations(); 
      } else {
        alert("‚ùå " + result.error);
      }
    };

    // ‚ùå Cancel update
    cancelBtn.onclick = () => {
      confirmBox.style.display = "none";
      alert("‚ùå Cancelled by user");
    };
  </script>
</body>
</html>
